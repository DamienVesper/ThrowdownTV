<link rel="stylesheet" href="/assets/css/chat.css">
<div class="chat-wrapper">
    <div class="chat-history"></div>
    <form class="chat-input-form">
        <textarea id="chat-input" placeholder="Send a message" class="form-control text-light" rows="1"></textarea>
        <input type="submit" id="chat-send" class="btn btn-sm btn-secondary" value="Chat">
    </form>
</div>

<script>
    fetch(`/authenticated`).then(data => data.json()).then(data => {
        const socket = io.connect(`${window.location.protocol}//${window.location.hostname}:8443`, {
            secure: true,
            rejectUnauthorized: true,
            withCredentials: true
        });

        socket.emit(`connectToChat`, data.username, data.token, window.location.href.split(`/`)[4]);

        socket.on(`handshake`, () => {
            console.log(`Succesfully connected to the chat server.`);
            $(`#chat-input`).focus();

            const sendChatMessage = () => {
                socket.emit(`chatMessage`, {
                    message: $(`#chat-input`).val()
                });
                $(`#chat-input`).val(``);
            }

            $(`#chat-input`).keydown(e => {
                if (e.key === `Enter`) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });

            $(`#chat-send`).on(`click`, e => {
                e.preventDefault();
                sendChatMessage();
            });
        });
    });
</script>