<%- include('./partials/header'); %>
<link rel="stylesheet" href="/assets/css/streamer.css">
<div id="streamer-error" class="alert alert-danger alert-dismissible fade show" role="alert">
    <span id="streamer-error-message"></span>
</div>
<div id="streamer-success" class="alert alert-success alert-dismissible fade show" role="alert">
    <span id="streamer-success-message"></span>
</div>
<div class="stream-overlay">
    <div class="stream-popout">
        <video id="live-stream" class="video-js vjs-fluid vjs-big-play-centered" controls preload="auto" autoplay="true"
            fluid="true" width="1280" height="720" poster="/assets/img/thumbnail.png">
            <p class="vjs-no-js">
                To view this video please enable JavaScript, and consider upgrading to a
                web browser that
                <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
            </p>
        </video>
        <div class="info-box">
            <img src="/assets/img/defaultpfp.png" class="rounded-circle profile-picture mr-3" alt="Profile picture">
            <div class="streamer-content">
                <span id="stream-title" class="lead mb-3"></span>
                <br>
                <span id="stream-display-name" class="lead mb-3"></span>
                <div class="description-box" id="stream-description"></div>
            </div>
            <div class="streamer-buttons">
                <div class="row">
                    <p class="followers"><i class="icofont-eye-alt"></i><span style="color: orange;" id="followcount"></span></p>
                    <form id="follow-btn-form" method="post" action="/follow">
                        <button id="follow-btn" type="submit" class="btn btn-sm btn-primary" style="margin-right: 5px;">Follow</button>
                    </form>
                    <form id="donation-link" method="get" action="/follow">
                        <button type="submit" class="btn btn-sm btn-success" style="margin-right: 5px;">Donate</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <iframe class="chat-popout" frameborder="0" height="720px"></iframe>
</div>
<script>
    $(document).ready(() => {
        const streamer = window.location.pathname.split(`/`)[1].toLowerCase();

        $(`#follow-btn-form`).attr(`action`, `/follow/${streamer}`)
        $(`#streamer-error`).hide();
        $(`#streamer-success`).hide();

        fetch(`/authenticated`).then(data => data.json()).then(userdata => {
            const username = userdata.username;

            $(`.chat-popout`).attr(`src`, `/chat/${streamer}`);

            let player = videojs(`live-stream`, {
                controls: true,
                autoplay: true,
                preload: `auto`
            });

            $(`#follow-btn-form`).attr(`action`, `/follow/${streamer}`)
            $(`#follow-btn`).attr(`title`, `Follow ${streamer}`)

            fetch(`/api/get-followers/${streamer}`).then(data => data.json()).then(data => {
                if (streamer === userdata.username) {
                    $(`#follow-btn`).attr(`disabled`, true);
                    $(`#follow-btn`).attr(`title`, `You cannot follow yourself.`)
                }
                if (data.followers.includes(userdata.username.toLowerCase())) {
                    $(`#follow-btn`).html(`Unfollow`)
                    $(`#follow-btn`).attr(`action`, `/unfollow/${streamer}`)
                    $(`#follow-btn`).attr(`title`, `Unfollow ${streamer}`)
                }
            });

            fetch(`/api/public-stream-data/${streamer}`).then(data => data.json()).then(data => {
                $(`#stream-display-name`).text(data.displayName);
                $(`#stream-title`).text(data.streamTitle);
                $(`#stream-description`).html(data.streamDescription);
                $(`#donation-link`).attr(`action`, `${data.donationLink}`);
                $(`#followcount`).text(data.followerCount)
            });

            $(`#follow-btn`).on(`click`, e => {
                e.preventDefault();

                $(`#follow-btn`).attr(`disabled`, true);

                let postUrl = `/follow/${streamer}`

                if ($(`#follow-btn`).html() === `Unfollow`) {
                    postUrl = `/unfollow/${streamer}`;
                    $(`#follow-btn-form`).attr(`action`, `/unfollow/${streamer}`)
                }

                $.ajax({
                    type: `post`,
                    url: `${postUrl}`,
                    data: $(`#follow-btn`).serialize()
                }).then(res => {
                    if (res.errors) {
                        $(`#streamer-error`).show();
                        $(`#streamer-error-message`).text(res.errors);
                    } else if (res.success) {
                        $(`#streamer-success`).show();
                        $(`#streamer-success-message`).text(res.success);
                    }
                    setTimeout(function(){ window.location.reload(true) }, 1000);
                });
            });

            setInterval(() => {
                fetch(`/api/public-stream-data/${streamer}`).then(data => data.json()).then(data => {
                    if (data.isSuspended) return window.location.reload();
                });
            }, 5000)

            player.src({
                src: `https://us01.throwdown.tv/live/${streamer}.flv`,
                type: `video/x-flv`
            });

            player.on(`error`, event => {
                player.src({
                    src: `/assets/video/throwdown.mp4`,
                    type: `video/mp4`
                });
            });
        });
    });
</script>